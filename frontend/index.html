<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
<title>BlueBase Dashboard</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/datepicker.css">
<!-- <link rel="stylesheet" href="css/bootstrap-theme.min.css"> -->
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-datepicker.js"></script>
<script src="js/chart.min.js"></script>
<script>
window.onload = loadElements;
function loadElements(){
  $('.datepicker').datepicker();
  $('[data-toggle="popover"]').popover();
  $.getJSON("request.php", processInfo);
}
function refreshData(){
  //location.reload();
}
function processInfo(response){
  userChart(response.statistics);
  jsonTable(response.users);
}
function userChart(statistics){
  var stats = [
    {
      value: statistics[0],
      color: "#009933",
      highlight: "#66C266",
      label: "Enabled"
    },
    {
      value: statistics[1],
      color: "#C21418",
      highlight: "#EC4A4F",
      label: "Expired"
    },
    {
      value: statistics[2],
      color: "#444444",
      highlight: "#777777",
      label: "Disabled"
    }
  ]
  var ctx = $("#userChart").get(0).getContext("2d");
  var usrChart = new Chart(ctx).Pie(stats, {responsive: true});
}
function toggleExpire(){
  if(document.getElementById("chkExpire").checked){
    $("#expireInput").removeAttr("disabled");
  }
  else{
     $("#expireInput").attr("disabled", "true");
     $("#expire").val("");
  }
}
function createUser(){
  var acctStatus = "0";
  var expiryDate = null;
  var passwd;
  var valiDate = /^\d{4}-[01]\d-[0-3]\d$/;
  if(document.getElementById("status").checked){
    acctStatus = "1";
  }
  else{
    acctStatus = "0";
  }
  if(document.getElementById("chkExpire").checked){
    var expiryDate = $("#expire").val();
  }
  else{
    var expiryDate = null;
  }
  if(valiDate.test(expiryDate) == false &&  expiryDate != null){
    alert("Expiration date not valid");
  }
  else if($("#password").val() == "" || $("#repeatpw").val() == ""){
    alert("You must set a password and repeat it");
  }
  else if($("#password").val() != $("#repeatpw").val()){
    alert("Password and repeated password do not match");
  }
  else{
    var user = {
      username: $("#username").val(),
      fname: $("#fname").val(),
      lname: $("#lname").val(),
      expire: expiryDate,
      status: acctStatus,
      password: $("#password").val(),
      repeat: $("#repeatpw").val(),
    }
    $.post("insert.php", user);
    refreshData();
  }
}
function jsonTable(users){
  var table = document.getElementById('usersTable');
  for(var i = 0; i < users.length; i++){
    var newRow = table.insertRow();
    var newCell = newRow.insertCell();
    var newText = document.createTextNode(users[i].userid);
    newCell.appendChild(newText);
    newCell = newRow.insertCell();
    newText = document.createTextNode(users[i].username);
    newCell.appendChild(newText);
    newCell = newRow.insertCell();
    newText = document.createTextNode(users[i].fname);
    newCell.appendChild(newText);
    newCell = newRow.insertCell();
    newText = document.createTextNode(users[i].lname);
    newCell.appendChild(newText);
    newCell = newRow.insertCell();
    newText = document.createTextNode(users[i].expiration);
    newCell.appendChild(newText);
    newCell = newRow.insertCell();
    if(users[i].disabled == 0)
      newText = document.createTextNode('False');
    else
      newText = document.createTextNode('True');
    newCell.appendChild(newText);
  }
}
</script>
</head>
<body>
  <div class="container">
    <div align="center">
      <h1>BlueBase Dashboard</h1>
    </div>
    <div class="col-md-4">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Create User</h3>
      </div>
      <div class="panel-body">
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-control" id="username" data-toggle="popover" title="Constraints" data-content="Valid characters: alphanumeric, _, -, ., @."/>
        </div>
        <div class="form-group">
          <label>First Name</label>
          <input type="text" class="form-control" id="fname" />
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" class="form-control" id="lname" />
        </div>
        <div class="checkbox">
        <label><input id="chkExpire" type="checkbox" checked="true" onclick="toggleExpire();">Enable Expiration</input></label>
        </div>
        <fieldset id="expireInput">
        <div class="form-group">
          <label>Expiration Date</label>
          <div class="input-group">
            <input class="datepicker form-control" data-date-format="yyyy-mm-dd" id="expire" pattern="d{4}-d{2}-d{2}"></input> 
            <span class="input-group-addon">
              <i class="glyphicon glyphicon-calendar"></i>
            </span>
          </div>
        </div>
        </fieldset>
        <label>Account status</label>
        <div class="checkbox">
          <label>
            <input type="checkbox" id="status">Disabled</input>
          </label>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" placeholder="password" class="form-control" id="password" />
        </div>
        <div class="form-group">
          <label>Repeat Password</label>
          <input type="password" placeholder="repeat" class="form-control" id="repeatpw" />
        </div>
        <button class="btn btn-success btn-block" onclick="createUser();">Submit</button>
      </div>
    </div>
    </div>
    <div class="col-md-8">
      <table class="table">
          <tr>
            <th>User ID</th>
            <th>Username</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Expiration</th>
            <th>Disabled</th>
          </tr>
          <tbody id="usersTable">
          </tbody>
      </table>
    </div>
    <div class="col-md-4">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">User chart</h3>
      </div>
      <div class="panel-body">
        <canvas id="userChart" width="250" height="200"></canvas>
      </div>
    </div>
    </div>
  </div>
</body>
</html>